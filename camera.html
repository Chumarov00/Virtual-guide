<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>AR — Видео по меткам</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

  <!-- A-Frame + MindAR (как в твоём рабочем файле) -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    /* =========================================================
      [СТИЛИ] База
    ========================================================= */
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; }
    #ar { position:fixed; inset:0; }

    /* =========================================================
      [СТИЛИ] Верхняя панель: Назад + Статус
    ========================================================= */
    .topBar{
      position:fixed; left:12px; right:12px; top:12px; z-index:9999;
      display:flex; gap:10px; align-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      pointer-events:auto;
    }
    .pillBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.45); backdrop-filter: blur(10px);
      color:rgba(255,255,255,.92); text-decoration:none;
      font-weight:900; font-size:13px; user-select:none;
    }
    .status{
      flex:1; padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.45); backdrop-filter: blur(10px);
      color:rgba(255,255,255,.92);
      text-align:center; font-weight:850; font-size:12px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* =========================================================
      [СТИЛИ] Оверлей запуска (одна кнопка)
    ========================================================= */
    #startOverlay{
      position:fixed; inset:0; z-index:9998;
      display:flex; align-items:center; justify-content:center;
      background: rgba(11,12,15,0.85);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .panel{
      width:min(720px, 92vw);
      border-radius:16px;
      padding:18px;
      background:#17191f;
      box-shadow:0 10px 30px rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;
    }
    .panel h3{ margin:0 0 8px; font-size:18px; }
    .panel p{ margin:0 0 14px; opacity:.85; font-size:13px; line-height:1.35; }

    .actions{ display:flex; gap:12px; justify-content:flex-end; flex-wrap:wrap; }
    button{
      border:0; padding:11px 14px; border-radius:12px; font-weight:800; cursor:pointer;
      font-family: inherit;
    }
    .ghost{ background:#31394a; color:#fff; }
    .primary{ background:#4aa8ff; color:#001525; }

    /* =========================================================
      [СТИЛИ] Окно видео (маленькое, снизу)
    ========================================================= */
    #videoDock{
      position:fixed;
      left:12px; right:12px;
      bottom:12px;
      z-index:9999;

      max-width:560px;
      margin:0 auto;

      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.40);
      backdrop-filter: blur(10px);
      box-shadow:0 18px 46px rgba(0,0,0,.40);

      display:none; /* включим через JS, когда будет найдено видео */
    }
    #videoHeader{
      display:flex; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:rgba(255,255,255,.92);
    }
    #videoTitle{ font-weight:950; font-size:13px; }
    #videoHint{ font-weight:800; font-size:12px; color:rgba(180,220,255,.95); }

    #arVideo{
      width:100%;
      height:190px;
      display:block;
      background:#000;
      object-fit:cover;
    }

    /* На маленьких экранах чуть ниже видео */
    @media (max-width: 420px){
      #arVideo{ height:170px; }
    }
  </style>
</head>

<body>

  <!-- =========================================================
    [UI] Верхняя панель
  ========================================================= -->
  <div class="topBar">
    <a class="pillBtn" href="./index.html">← Назад</a>
    <div class="status" id="status">Нажмите «Запустить AR»</div>
  </div>

  <!-- =========================================================
    [UI] Оверлей запуска (одна кнопка)
  ========================================================= -->
  <div id="startOverlay">
    <div class="panel">
      <h3>Запуск AR</h3>
      <p>
        Нажмите кнопку, разрешите доступ к камере и наведите на метку/фото здания.
        <br><span style="opacity:.75">Видео появится внизу экрана.</span>
      </p>
      <div class="actions">
        <button class="ghost" id="reloadBtn" type="button">Обновить</button>
        <button class="primary" id="startBtn" type="button">Запустить AR</button>
      </div>
      <p style="margin-top:10px; font-size:12px; opacity:.65">
        Если будет чёрный экран — чаще всего камера занята другой вкладкой/приложением.
      </p>
    </div>
  </div>

  <!-- =========================================================
    [UI] Окно видео (снизу)
  ========================================================= -->
  <div id="videoDock">
    <div id="videoHeader">
      <div id="videoTitle">Видео</div>
      <div id="videoHint">Сканирование…</div>
    </div>
    <!-- muted=true помогает autoplay. controls оставил, чтобы можно было нажать Play при блокировке -->
    <video id="arVideo" playsinline webkit-playsinline muted controls></video>
  </div>

  <!-- =========================================================
    [AR] A-Frame сцена
    ВАЖНО: targets.mind лежит рядом с этим файлом => "./targets.mind"
  ========================================================= -->
  <div id="ar">
    <a-scene
      id="scene"
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiScanning: false; uiError: false;"
      renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true"
      embedded>

      <!-- Свет (чтобы сцена не была тёмной, хотя видео у нас HTML-оверлей) -->
      <a-entity light="type: hemisphere; intensity: 0.9"></a-entity>
      <a-entity light="type: directional; intensity: 0.9" position="1 2 1"></a-entity>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Контейнер: сюда JS добавит 25 targets (0..24) -->
      <a-entity id="targetsRoot"></a-entity>
    </a-scene>
  </div>

  <script>
    /* =========================================================
      [НАСТРОЙКИ] 1) Где лежит targets.mind
      Если файл targets.mind лежит в этой же папке — НЕ ТРОГАЙ.
      Если лежит в подпапке targets/ — поменяй на "./targets/targets.mind"
    ========================================================= */
    const TARGETS_PATH = "./targets.mind";

    /* =========================================================
      [НАСТРОЙКИ] 2) Видео и диапазоны меток
      ТЫ ПРОСИЛ:
      0..7   -> Bulygin
      8..14  -> Naumov
      15..24 -> Pchelin

      ВАЖНО:
      - НЕ используй github.com/.../blob/...mp4
      - Используй прямой mp4 (лучше GitHub Pages) или относительный путь ./videos/...
    ========================================================= */
    const VIDEO_URLS = {
      bulygin: "https://chumarov00.github.io/Virtual-guide/Bulygin%27s%20House.mp4",
      naumov:  "https://chumarov00.github.io/Virtual-guide/Naumov%27s%20house.mp4",
      pchelin: "https://chumarov00.github.io/Virtual-guide/Pchelin%27s%20House.MP4"
    };

    function groupByIndex(i){
      if (i >= 0 && i <= 7) return "bulygin";
      if (i >= 8 && i <= 14) return "naumov";
      if (i >= 15 && i <= 24) return "pchelin";
      return null;
    }

    /* =========================================================
      [DOM] Элементы UI
    ========================================================= */
    const statusEl = document.getElementById("status");
    const startOverlay = document.getElementById("startOverlay");
    const startBtn = document.getElementById("startBtn");
    const reloadBtn = document.getElementById("reloadBtn");

    const videoDock  = document.getElementById("videoDock");
    const videoTitle = document.getElementById("videoTitle");
    const videoHint  = document.getElementById("videoHint");
    const videoEl    = document.getElementById("arVideo");

    const sceneEl = document.getElementById("scene");
    const targetsRoot = document.getElementById("targetsRoot");

    function setStatus(t){ statusEl.textContent = t; }

    /* =========================================================
      [ЛОГИКА] Создание target-entity 0..24 и обработчики targetFound/targetLost
    ========================================================= */
    function buildTargets(){
      targetsRoot.innerHTML = "";

      for(let i=0; i<=24; i++){
        const holder = document.createElement("a-entity");
        holder.setAttribute("mindar-image-target", `targetIndex: ${i}`);

        holder.addEventListener("targetFound", () => onFound(i));
        holder.addEventListener("targetLost",  () => onLost(i));

        targetsRoot.appendChild(holder);
      }
    }

    /* =========================================================
      [ЛОГИКА] Видео-управление
      - при найденной метке ставим нужный mp4 и запускаем
      - при потере метки НЕ останавливаем (как ты просил)
    ========================================================= */
    let currentGroup = null;
    let currentIndex = null;

    async function onFound(idx){
      const group = groupByIndex(idx);
      if(!group){
        setStatus(`Найдена метка #${idx}, но нет правила видео`);
        return;
      }

      const src = VIDEO_URLS[group];
      currentGroup = group;
      currentIndex = idx;

      videoDock.style.display = "block";
      videoTitle.textContent = `Видео: ${group} (метка #${idx})`;
      videoHint.textContent  = "Метка найдена";

      // Если уже играет то же видео — не перезапускаем
      if (videoEl.src === src && !videoEl.paused){
        setStatus(`Метка #${idx} — продолжаю видео`);
        return;
      }

      // Меняем источник
      videoEl.src = src;

      // Попробуем autoplay (muted помогает)
      try{
        await videoEl.play();
        setStatus(`Метка #${idx} — видео играет`);
      }catch(e){
        // Если браузер блокирует — пользователь нажмёт Play на controls
        setStatus(`Метка #${idx} — нажми Play (автозапуск заблокирован)`);
        videoHint.textContent = "Нажми Play";
        console.error(e);
      }
    }

    function onLost(idx){
      if (idx === currentIndex){
        setStatus(`Метка #${idx} потеряна — видео продолжается`);
        videoHint.textContent = "Метка потеряна — видео продолжается";
      }
      // НИЧЕГО не останавливаем
    }

    /* =========================================================
      [ЛОГИКА] Запуск/остановка MindAR (как в твоём рабочем файле)
    ========================================================= */
    async function checkTargetsFile(){
      // Гарантируем, что mindar-image читает именно тот путь, который мы хотим
      sceneEl.setAttribute("mindar-image", `imageTargetSrc: ${TARGETS_PATH}; autoStart: false; uiScanning: false; uiError: false;`);

      try{
        const r = await fetch(TARGETS_PATH, { cache: "no-store" });
        if(!r.ok){
          throw new Error(`targets.mind не найден: HTTP ${r.status}`);
        }
        return true;
      }catch(e){
        setStatus("targets.mind не загрузился — проверь путь и GitHub Pages");
        alert("targets.mind не загрузился. Проверь, что он лежит рядом с camera.html и доступен по HTTPS.");
        console.error(e);
        return false;
      }
    }

    async function startAR(){
      const ok = await checkTargetsFile();
      if(!ok) return;

      buildTargets();

      const mindar = sceneEl.systems["mindar-image-system"];
      if(!mindar){
        setStatus("MindAR system не найден (ошибка подключения MindAR)");
        alert("MindAR system не найден. Проверь подключение mindar-image-aframe.prod.js");
        return;
      }

      try{
        setStatus("Запуск камеры…");
        await mindar.start();
        setStatus("Камера запущена — наведи на метку");
        startOverlay.style.display = "none";
      }catch(e){
        // Частые причины: NotReadableError (камера занята), NotAllowedError (нет разрешения)
        setStatus(`Не удалось запустить камеру: ${e?.name || "ошибка"}`);
        alert("Не удалось запустить камеру/AR. Проверь разрешение и что камера не занята другой вкладкой/приложением.");
        console.error(e);
      }
    }

    /* =========================================================
      [СОБЫТИЯ UI]
    ========================================================= */
    reloadBtn.addEventListener("click", () => location.reload());
    startBtn.addEventListener("click", startAR);

    // На старте — просто статус
    setStatus("Нажмите «Запустить AR»");
  </script>
</body>
</html>
