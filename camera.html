<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>AR ‚Äî –ü—Ä–∏–∑—Ä–∞–∫–∏ –ø—Ä–æ—à–ª–æ–≥–æ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>

  <!-- A-Frame + MindAR (–ø–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω) -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    /* =========================================================
      [BASE] –ë–∞–∑–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    ========================================================= */
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; }
    #ar { position:fixed; inset:0; }

    /* =========================================================
      [TOP BAR] –ù–∞–∑–∞–¥ + –°—Ç–∞—Ç—É—Å
      –í–ê–ñ–ù–û: z-index –≤—ã—à–µ, —á–µ–º —É –≤—Å–µ—Ö –æ–≤–µ—Ä–ª–µ–µ–≤
    ========================================================= */
    .topBar{
      position:fixed; left:12px; right:12px; top:12px; z-index:10050;
      display:flex; gap:10px; align-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      pointer-events:auto;
    }
    .pillBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.45); backdrop-filter: blur(10px);
      color:rgba(255,255,255,.92); text-decoration:none;
      font-weight:900; font-size:13px; user-select:none;
    }
    .status{
      flex:1; padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.45); backdrop-filter: blur(10px);
      color:rgba(255,255,255,.92);
      text-align:center; font-weight:850; font-size:12px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* =========================================================
      [ROTATE HINT] –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
      pointer-events:none => –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–ª–∏–∫–∏
    ========================================================= */
    #rotateHint{
      position:fixed; inset:0; z-index:10020;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55);
      pointer-events:none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .rotateCard{
      width:min(520px, 92vw);
      border-radius:18px;
      padding:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(16,18,24,.75);
      backdrop-filter: blur(12px);
      color:#fff;
      text-align:center;
    }
    .rotateIcon{
      width:64px; height:64px;
      margin:0 auto 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(120px 60px at 30% 30%, rgba(74,168,255,.35), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      display:flex; align-items:center; justify-content:center;
      font-size:30px;
    }
    .rotateTitle{ font-weight:950; font-size:15px; margin:0 0 6px; }
    .rotateText{ opacity:.85; font-size:13px; line-height:1.35; }

    /* =========================================================
      [START OVERLAY] –°—Ç–∞—Ä—Ç AR (–Ω—É–∂–µ–Ω –∂–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    ========================================================= */
    #startOverlay{
      position:fixed; inset:0; z-index:9998;
      display:flex; align-items:center; justify-content:center;
      background: rgba(11,12,15,0.85);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .panel{
      width:min(720px, 92vw);
      border-radius:16px;
      padding:18px;
      background:#17191f;
      box-shadow:0 10px 30px rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;
    }
    .panel h3{ margin:0 0 8px; font-size:18px; }
    .panel p{ margin:0 0 14px; opacity:.85; font-size:13px; line-height:1.35; }
    .actions{ display:flex; gap:12px; justify-content:flex-end; flex-wrap:wrap; }
    button{
      border:0; padding:11px 14px; border-radius:12px; font-weight:800; cursor:pointer;
      font-family: inherit;
    }
    .ghost{ background:#31394a; color:#fff; }
    .primary{ background:#4aa8ff; color:#001525; }

    /* =========================================================
      [VIDEO OVERLAY] –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–µ–æ
      –í–ê–ñ–ù–û: –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å INLINE (–Ω–µ —É—Ö–æ–¥–∏—Ç—å –≤ fullscreen)
    ========================================================= */
    #videoDock{
      position:fixed;
      left:0; right:0; top:0; bottom:0;
      z-index:10030;
      background:#000;
      display:none; /* –≤–∫–ª—é—á–∏–º —á–µ—Ä–µ–∑ JS, –∫–æ–≥–¥–∞ –Ω–∞—à–ª–∏ –º–µ—Ç–∫—É */
    }

    /* –°–∞–º–æ –≤–∏–¥–µ–æ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω, –Ω–æ inline */
    #arVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      display:block;
      background:#000;
      object-fit:contain;
      opacity: 1; /* –º–µ–Ω—è–µ—Ç—Å—è –ø–æ–ª–∑—É–Ω–∫–æ–º */
    }

    /* –ü—Ä—è—á–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã (–Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –≤—Å—ë —Ä–∞–≤–Ω–æ –º–æ–≥—É—Ç –ø–æ—è–≤–∏—Ç—å—Å—è) */
    video::-webkit-media-controls { display:none !important; }
    video::-webkit-media-controls-panel { display:none !important; }

    /* =========================================================
      [VIDEO CONTROLS] –ù–∞—à–∏ –∫–Ω–æ–ø–∫–∏ –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ
    ========================================================= */
    #videoControls{
      position:absolute;
      left:12px;
      bottom:12px;
      z-index:10040;
      display:flex;
      gap:10px;
      align-items:center;
      pointer-events:auto;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .vbtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      color:rgba(255,255,255,.92);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      user-select:none;
      cursor:pointer;
    }

    .vhint{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      color:rgba(180,220,255,.95);
      font-weight:850;
      font-size:12px;
      max-width:min(62vw, 520px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* =========================================================
      [OPACITY SLIDER] –ü–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ —Å–ø—Ä–∞–≤–∞
    ========================================================= */
    #opacityControl{
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10045;
      display: none;  /* –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ –≤–∏–¥–µ–æ */
      padding: 12px 10px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: rgba(255,255,255,.92);
      user-select: none;
      pointer-events: auto;
    }
    #opacityLabel{
      font-size: 12px;
      font-weight: 900;
      text-align: center;
      margin-bottom: 10px;
      opacity: .9;
    }
    #opacitySlider{
      width: 240px;
      height: 28px;
      transform: rotate(-90deg);
      transform-origin: center;
      cursor: pointer;
    }
    #opacityMinMax{
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      opacity: .75;
    }
  </style>
</head>

<body>

  <!-- [UI] –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
  <div class="topBar">
    <a class="pillBtn" href="./index.html">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="status" id="status">–ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å AR¬ª</div>
  </div>

  <!-- [UI] –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω -->
  <div id="rotateHint" aria-hidden="true">
    <div class="rotateCard">
      <div class="rotateIcon">üì±‚Üª</div>
      <div class="rotateTitle">–ü–æ–≤–µ—Ä–Ω–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ</div>
      <div class="rotateText">–¢–∞–∫ –º–µ—Ç–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ, –∞ ‚Äú–ø—Ä–∏–∑—Ä–∞–∫‚Äù –≤—ã–≥–ª—è–¥–∏—Ç –ª—É—á—à–µ.</div>
    </div>
  </div>

  <!-- [UI] –û–≤–µ—Ä–ª–µ–π –∑–∞–ø—É—Å–∫–∞ -->
  <div id="startOverlay">
    <div class="panel">
      <h3>–ü—Ä–∏–∑—Ä–∞–∫–∏ –ø—Ä–æ—à–ª–æ–≥–æ</h3>
      <p>
        –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –Ω–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —Ñ–æ—Ç–æ/–∑–¥–∞–Ω–∏–µ.
        <br><span style="opacity:.75">–ü–æ—Ç–æ–º —É–º–µ–Ω—å—à–∞–π—Ç–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ ‚Äî –∏ —É–≤–∏–¥–∏—Ç–µ ‚Äú–ø—Ä–∏–∑—Ä–∞–∫‚Äù –ø–æ–≤–µ—Ä—Ö —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏.</span>
      </p>
      <div class="actions">
        <button class="ghost" id="reloadBtn" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="primary" id="startBtn" type="button">–ó–∞–ø—É—Å—Ç–∏—Ç—å AR</button>
      </div>
      <p style="margin-top:10px; font-size:12px; opacity:.65">
        –ï—Å–ª–∏ —á—ë—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω ‚Äî –∫–∞–º–µ—Ä–∞ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–æ–π/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.
      </p>
    </div>
  </div>

  <!-- =========================================================
    [VIDEO] –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π inline-–æ–≤–µ—Ä–ª–µ–π (–∫–∞–º–µ—Ä–∞ –æ—Å—Ç–∞—ë—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–¥ –Ω–∏–º)
  ========================================================= -->
  <div id="videoDock">
    <video id="arVideo" playsinline webkit-playsinline muted></video>

    <!-- –ù–∞—à–∏ –∫–Ω–æ–ø–∫–∏ (–ù–ï –Ω–∞—Ç–∏–≤–Ω—ã–µ controls) -->
    <div id="videoControls">
      <button class="vbtn" id="playPauseBtn" type="button">‚è∏ –ü–∞—É–∑–∞</button>
      <div class="vhint" id="videoHint">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ‚Ä¶</div>
    </div>

    <!-- –ü–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ -->
    <div id="opacityControl" aria-label="–†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ">
      <div id="opacityLabel">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å</div>
      <input id="opacitySlider" type="range" min="20" max="100" value="100" step="1" />
      <div id="opacityMinMax">
        <span>20%</span>
        <span>100%</span>
      </div>
    </div>
  </div>

  <!-- =========================================================
    [AR] A-Frame —Å—Ü–µ–Ω–∞
  ========================================================= -->
  <div id="ar">
    <a-scene
      id="scene"
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; uiScanning: false; uiError: false;"
      renderer="colorManagement: true; physicallyCorrectLights: true; antialias: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true"
      embedded>

      <a-entity light="type: hemisphere; intensity: 0.9"></a-entity>
      <a-entity light="type: directional; intensity: 0.9" position="1 2 1"></a-entity>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: —Å—é–¥–∞ JS –¥–æ–±–∞–≤–∏—Ç targets 0..24 -->
      <a-entity id="targetsRoot"></a-entity>
    </a-scene>
  </div>

  <script>
    /* =========================================================
      [CONFIG] targets.mind
    ========================================================= */
    const TARGETS_PATH = "./targets.mind";

    /* =========================================================
      [CONFIG] –í–∏–¥–µ–æ –ø–æ –≥—Ä—É–ø–ø–∞–º –º–µ—Ç–æ–∫
    ========================================================= */
    const VIDEO_URLS = {
      bulygin: "https://chumarov00.github.io/Virtual-guide/Bulygin%27s%20House.mp4",
      naumov:  "https://chumarov00.github.io/Virtual-guide/Naumov%27s%20house.mp4",
      pchelin: "https://chumarov00.github.io/Virtual-guide/Pchelin%27s%20House.MP4"
    };

    function groupByIndex(i){
      if (i >= 0 && i <= 7) return "bulygin";
      if (i >= 8 && i <= 14) return "naumov";
      if (i >= 15 && i <= 24) return "pchelin";
      return null;
    }

    /* =========================================================
      [DOM]
    ========================================================= */
    const statusEl = document.getElementById("status");
    const startOverlay = document.getElementById("startOverlay");
    const startBtn = document.getElementById("startBtn");
    const reloadBtn = document.getElementById("reloadBtn");

    const rotateHint = document.getElementById("rotateHint");

    const videoDock = document.getElementById("videoDock");
    const videoEl = document.getElementById("arVideo");
    const videoHintEl = document.getElementById("videoHint");

    const playPauseBtn = document.getElementById("playPauseBtn");

    const opacityControl = document.getElementById("opacityControl");
    const opacitySlider = document.getElementById("opacitySlider");

    const sceneEl = document.getElementById("scene");
    const targetsRoot = document.getElementById("targetsRoot");

    function setStatus(t){ statusEl.textContent = t; }

    /* =========================================================
      [ROTATE HINT] –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ/–ø–ª–∞–Ω—à–µ—Ç–µ –∏ –≤ –ø–æ—Ä—Ç—Ä–µ—Ç–µ
    ========================================================= */
    let arStartedOnce = false;

    function isMobileLike(){
      return window.matchMedia && window.matchMedia("(pointer: coarse)").matches;
    }
    function isPortrait(){
      if (window.matchMedia) return window.matchMedia("(orientation: portrait)").matches;
      return window.innerHeight > window.innerWidth;
    }
    function updateRotateHint(){
      if (!arStartedOnce){
        rotateHint.style.display = "none";
        return;
      }
      if (isMobileLike() && isPortrait()){
        rotateHint.style.display = "flex";
      } else {
        rotateHint.style.display = "none";
      }
    }
    window.addEventListener("resize", updateRotateHint);
    window.addEventListener("orientationchange", updateRotateHint);

    /* =========================================================
      [OPACITY] –ü–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
    ========================================================= */
    opacitySlider.addEventListener("input", () => {
      const alpha = Number(opacitySlider.value) / 100;  // 0.2..1.0
      videoEl.style.opacity = String(alpha);
    });

    /* =========================================================
      [INLINE VIDEO HARDENING] —á—Ç–æ–±—ã –Ω–µ —É—Ö–æ–¥–∏–ª–æ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π fullscreen
      –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞ —á–∞—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –Ω–æ 100% –≥–∞—Ä–∞–Ω—Ç–∏–π –Ω–∞ –≤—Å–µ—Ö iOS –Ω–µ—Ç. [Unverified]
    ========================================================= */
    function hardenInlineVideo(){
      videoEl.muted = true;                 // —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ autoplay
      videoEl.playsInline = true;           // iOS inline
      videoEl.setAttribute("playsinline", "");
      videoEl.setAttribute("webkit-playsinline", "");
      videoEl.disablePictureInPicture = true;
      videoEl.setAttribute("disablePictureInPicture", "");
      videoEl.preload = "auto";
    }
    hardenInlineVideo();

    /* =========================================================
      [PLAY/PAUSE] —Å–≤–æ—è –∫–Ω–æ–ø–∫–∞ (–±–µ–∑ native controls)
    ========================================================= */
    playPauseBtn.addEventListener("click", async () => {
      try{
        if (videoEl.paused){
          await videoEl.play();
          playPauseBtn.textContent = "‚è∏ –ü–∞—É–∑–∞";
          videoHintEl.textContent = "–í–∏–¥–µ–æ –∏–≥—Ä–∞–µ—Ç (–∫–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)";
        } else {
          videoEl.pause();
          playPauseBtn.textContent = "‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å";
          videoHintEl.textContent = "–ü–∞—É–∑–∞ (–∫–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)";
        }
      }catch(e){
        // –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –≤—Å—ë —Ä–∞–≤–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ ‚Äî –ø–æ–∫–∞–∂–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        playPauseBtn.textContent = "‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å";
        videoHintEl.textContent = "–ù–∞–∂–º–∏ –µ—â—ë —Ä–∞–∑ (–±—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç)";
        console.error(e);
      }
    });

    /* =========================================================
      [TARGETS] –°–æ–∑–¥–∞–Ω–∏–µ target-entity 0..24
    ========================================================= */
    function buildTargets(){
      targetsRoot.innerHTML = "";
      for(let i=0; i<=24; i++){
        const holder = document.createElement("a-entity");
        holder.setAttribute("mindar-image-target", `targetIndex: ${i}`);
        holder.addEventListener("targetFound", () => onFound(i));
        holder.addEventListener("targetLost",  () => onLost(i));
        targetsRoot.appendChild(holder);
      }
    }

    /* =========================================================
      [VIDEO LOGIC]
      - –ø—Ä–∏ found: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ-–æ–≤–µ—Ä–ª–µ–π (–ø—Ä–∏–∑—Ä–∞–∫) –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
      - –ø—Ä–∏ lost: –ù–ï –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º (–∫–∞–∫ —Ç—ã –ø—Ä–æ—Å–∏–ª)
      –ö–∞–º–µ—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ—Ç–æ–º—É —á—Ç–æ MindAR –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º.
    ========================================================= */
    let currentIndex = null;
    let currentSrc = "";

    async function onFound(idx){
      const group = groupByIndex(idx);
      if(!group){
        setStatus(`–ù–∞–π–¥–µ–Ω–∞ –º–µ—Ç–∫–∞ #${idx}, –Ω–æ –Ω–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –≤–∏–¥–µ–æ`);
        return;
      }

      const src = VIDEO_URLS[group];
      currentIndex = idx;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π —Å –≤–∏–¥–µ–æ –∏ –ø–æ–ª–∑—É–Ω–∫–æ–º
      videoDock.style.display = "block";
      opacityControl.style.display = "block";

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –Ω–∞ 100% (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —É–º–µ–Ω—å—à–∏—Ç)
      opacitySlider.value = "100";
      videoEl.style.opacity = "1";

      // –ü–æ–¥—Å–∫–∞–∑–∫–∏
      setStatus(`–ú–µ—Ç–∫–∞ #${idx} –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –∑–∞–ø—É—Å–∫–∞—é ‚Äú–ø—Ä–∏–∑—Ä–∞–∫–∞‚Äù`);
      videoHintEl.textContent = `–ú–µ—Ç–∫–∞ #${idx} –Ω–∞–π–¥–µ–Ω–∞ ‚Äî ‚Äú–ü—Ä–∏–∑—Ä–∞–∫‚Äù –≤–∫–ª—é—á—ë–Ω`;

      // –ï—Å–ª–∏ —ç—Ç–æ —Ç–æ –∂–µ –≤–∏–¥–µ–æ –∏ –æ–Ω–æ —É–∂–µ –∏–≥—Ä–∞–µ—Ç ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
      if (currentSrc === src && !videoEl.paused){
        return;
      }

      // –ú–µ–Ω—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
      currentSrc = src;
      videoEl.src = src;

      // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å. muted –ø–æ–º–æ–≥–∞–µ—Ç.
      try{
        await videoEl.play();
        playPauseBtn.textContent = "‚è∏ –ü–∞—É–∑–∞";
      }catch(e){
        // –ï—Å–ª–∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º—ë—Ç –Ω–∞—à—É –∫–Ω–æ–ø–∫—É Play
        playPauseBtn.textContent = "‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å";
        videoHintEl.textContent = "–ù–∞–∂–º–∏ ‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å (–∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)";
        console.error(e);
      }
    }

    function onLost(idx){
      if (idx === currentIndex){
        setStatus(`–ú–µ—Ç–∫–∞ #${idx} –ø–æ—Ç–µ—Ä—è–Ω–∞ ‚Äî –≤–∏–¥–µ–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è`);
        videoHintEl.textContent = "–ú–µ—Ç–∫–∞ –ø–æ—Ç–µ—Ä—è–Ω–∞ ‚Äî ‚Äú–ø—Ä–∏–∑—Ä–∞–∫‚Äù –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è";
      }
      // –ù–ò–ß–ï–ì–û –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
    }

    /* =========================================================
      [START AR]
    ========================================================= */
    async function checkTargetsFile(){
      sceneEl.setAttribute(
        "mindar-image",
        `imageTargetSrc: ${TARGETS_PATH}; autoStart: false; uiScanning: false; uiError: false;`
      );

      try{
        const r = await fetch(TARGETS_PATH, { cache: "no-store" });
        if(!r.ok) throw new Error(`targets.mind –Ω–µ –Ω–∞–π–¥–µ–Ω: HTTP ${r.status}`);
        return true;
      }catch(e){
        setStatus("targets.mind –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø—É—Ç—å –∏ GitHub Pages");
        alert("targets.mind –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –æ–Ω –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å camera.html –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS.");
        console.error(e);
        return false;
      }
    }

    async function startAR(){
      const ok = await checkTargetsFile();
      if(!ok) return;

      buildTargets();

      const mindar = sceneEl.systems["mindar-image-system"];
      if(!mindar){
        setStatus("MindAR system –Ω–µ –Ω–∞–π–¥–µ–Ω");
        alert("MindAR system –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ mindar-image-aframe.prod.js");
        return;
      }

      try{
        setStatus("–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã‚Ä¶");
        await mindar.start();
        setStatus("–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ ‚Äî –Ω–∞–≤–µ–¥–∏ –Ω–∞ –º–µ—Ç–∫—É");
        startOverlay.style.display = "none";

        arStartedOnce = true;
        updateRotateHint();
      }catch(e){
        setStatus(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É: ${e?.name || "–æ—à–∏–±–∫–∞"}`);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É/AR. –ü—Ä–æ–≤–µ—Ä—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏ —á—Ç–æ –∫–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–æ–π/–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.");
        console.error(e);
      }
    }

    /* =========================================================
      [UI EVENTS]
    ========================================================= */
    reloadBtn.addEventListener("click", () => location.reload());
    startBtn.addEventListener("click", startAR);

    setStatus("–ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å AR¬ª");
  </script>
</body>
</html>
